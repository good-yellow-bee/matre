# docker-compose.yml for MATRE (Magento Automated Test Run Environment)
#
# This configuration is intended for local development.
# Includes: Symfony app, Selenium Grid, Playwright, Allure, Magento 2
# ⚠️ Do not deploy this file to production; secrets and ports are dev-only defaults.
#
services:
  php:
    build:
      context: .
      target: app_dev
    container_name: matre_php
    volumes:
      - .:/app
      - matre_vendor:/app/vendor
      - /var/run/docker.sock:/var/run/docker.sock
    env_file: .env
    environment:
      APP_SECRET: "matre-dev-secret"
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: matre
      DB_USER: matre
      DB_PASS: matre
      MAILER_DSN: "smtp://mailpit:1025"
      ALLURE_URL: http://allure:5050
      ALLURE_PUBLIC_URL: http://matre.local:5050
    depends_on:
      - frontend-build
      - db
    networks:
      - matre_network

  nginx:
    image: nginx:1.25-alpine
    container_name: matre_nginx
    # ports:
    #   - "8089:80" # Disabled - Traefik handles HTTPS
    volumes:
      - .:/app:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php
    networks:
      - matre_network
      - traefik
    labels:
      # Traefik routing (for production profile)
      - "traefik.enable=true"
      - "traefik.http.routers.matre.rule=Host(`${APP_DOMAIN:-matre.local}`)"
      - "traefik.http.routers.matre.entrypoints=websecure"
      - "traefik.http.routers.matre.tls=true"
      - "traefik.http.routers.matre.tls.certresolver=${CERT_RESOLVER:-}"
      - "traefik.http.routers.matre.middlewares=security-headers@file"
      - "traefik.http.services.matre.loadbalancer.server.port=80"
      # HTTP redirect to HTTPS
      - "traefik.http.routers.matre-http.rule=Host(`${APP_DOMAIN:-matre.local}`)"
      - "traefik.http.routers.matre-http.entrypoints=web"
      - "traefik.http.routers.matre-http.middlewares=redirect-https"
      - "traefik.http.middlewares.redirect-https.redirectscheme.scheme=https"

  db:
    image: mariadb:11
    container_name: matre_db
    ports:
      - "33067:3306"
    environment:
      MARIADB_DATABASE: matre
      MARIADB_USER: matre
      MARIADB_PASSWORD: matre
      MARIADB_ROOT_PASSWORD: matre_root
    volumes:
      - matre_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - matre_network

  mailpit:
    image: axllent/mailpit:latest
    container_name: matre_mailpit
    ports:
      - "1031:1025"  # SMTP
      - "8031:8025"  # Web UI
    networks:
      - matre_network

  frontend-build:
    image: node:20-alpine
    container_name: matre_frontend_build
    working_dir: /app
    command: sh -c "npm install && npm run build"
    volumes:
      - .:/app
    networks:
      - matre_network

  scheduler:
    build:
      context: .
      target: app_dev
    container_name: matre_scheduler
    command: php bin/console messenger:consume scheduler_cron --time-limit=60 -vv
    restart: unless-stopped
    volumes:
      - .:/app
      - matre_vendor:/app/vendor
    env_file: .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: matre
      DB_USER: matre
      DB_PASS: matre
    depends_on:
      db:
        condition: service_healthy
      php:
        condition: service_started
    networks:
      - matre_network

  # ===========================================
  # Production SSL (optional)
  # ===========================================
  # Run with: docker-compose --profile production up -d

  traefik:
    image: traefik:v3.2
    container_name: matre_traefik
    profiles:
      - production
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./docker/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_certs:/letsencrypt
    environment:
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-}
    networks:
      - matre_network
    restart: unless-stopped

  # ===========================================
  # Test Infrastructure Services
  # ===========================================

  # Selenium Hub - Grid coordinator
  selenium-hub:
    image: selenium/hub:4.15
    container_name: matre_selenium_hub
    ports:
      - "4442:4442"
      - "4443:4443"
      - "4444:4444"
    environment:
      SE_NODE_MAX_SESSIONS: 4
      SE_SESSION_REQUEST_TIMEOUT: 300
    networks:
      - matre_network

  # Chrome Node - Browser for MFTF tests (scalable)
  chrome-node:
    image: selenium/node-chrome:4.15
    container_name: matre_chrome_node
    shm_size: 2gb
    depends_on:
      - selenium-hub
    environment:
      SE_EVENT_BUS_HOST: selenium-hub
      SE_EVENT_BUS_PUBLISH_PORT: 4442
      SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
      SE_NODE_MAX_SESSIONS: 2
      SE_NODE_SESSION_TIMEOUT: 300
    networks:
      - matre_network

  # Playwright Runner - For Playwright tests
  playwright:
    build:
      context: ./docker/playwright
      dockerfile: Dockerfile
    container_name: matre_playwright
    volumes:
      - ./var/test-modules:/app/modules:ro
      - ./var/playwright-results:/app/results
    environment:
      DISPLAY: ":99"
    networks:
      - matre_network

  # Allure Report Service
  allure:
    image: frankescobar/allure-docker-service:latest
    container_name: matre_allure
    ports:
      - "5050:5050"
      - "5252:5252"
    volumes:
      - ./var/allure-results:/app/allure-results
      - ./var/allure-reports:/app/default-reports
    environment:
      CHECK_RESULTS_EVERY_SECONDS: 3
      KEEP_HISTORY: 25
      KEEP_HISTORY_LATEST: 10
    networks:
      - matre_network

  # Magento 2 - For MFTF binary and test execution
  magento:
    build:
      context: ./docker/magento
      dockerfile: Dockerfile
    container_name: matre_magento
    volumes:
      - matre_magento_code:/var/www/html
      - ./var/test-modules:/var/www/html/app/code/Test:ro
      - ./var/mftf-results:/var/www/html/dev/tests/acceptance/tests/_output
      - ./var/mftf-results/allure-results:/var/www/html/dev/tests/acceptance/allure-results
      # Dev mode: mount local module for DEV_MODULE_PATH symlinks
      - ./abb-custom-mftf:/app/abb-custom-mftf:ro
    env_file: .env
    environment:
      MAGENTO_RUN_MODE: developer
      MAGENTO_VERSION: ${MAGENTO_VERSION:-2.4.7}
      MAGENTO_PUBLIC_KEY: ${MAGENTO_PUBLIC_KEY:-}
      MAGENTO_PRIVATE_KEY: ${MAGENTO_PRIVATE_KEY:-}
      DB_HOST: magento-db
      DB_NAME: magento
      DB_USER: magento
      DB_PASS: magento
      ES_HOST: magento-elasticsearch
      REDIS_HOST: magento-redis
      SELENIUM_HOST: selenium-hub
      SELENIUM_PORT: 4444
    depends_on:
      - magento-db
      - magento-elasticsearch
      - magento-redis
      - selenium-hub
    networks:
      - matre_network

  # Magento Database
  magento-db:
    image: mariadb:10.6
    container_name: matre_magento_db
    environment:
      MYSQL_DATABASE: magento
      MYSQL_USER: magento
      MYSQL_PASSWORD: magento
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - matre_magento_db_data:/var/lib/mysql
    networks:
      - matre_network

  # Magento Elasticsearch
  magento-elasticsearch:
    image: elasticsearch:7.17.14
    container_name: matre_magento_es
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - matre_magento_es_data:/usr/share/elasticsearch/data
    networks:
      - matre_network

  # Magento Redis
  magento-redis:
    image: redis:7-alpine
    container_name: matre_magento_redis
    networks:
      - matre_network

  # Test Worker - Consumes per-environment test_runner queue
  test-worker:
    build:
      context: .
      target: app_dev
    container_name: matre_test_worker
    command: php bin/console messenger:consume test_runner_per_env --time-limit=3600 -vv
    restart: unless-stopped
    volumes:
      - .:/app
      - matre_vendor:/app/vendor
      - ./var/test-modules:/app/var/test-modules
      - ./var/mftf-results:/app/var/mftf-results
      - ./var/playwright-results:/app/var/playwright-results
      - ./var/allure-results:/app/var/allure-results
      - /var/run/docker.sock:/var/run/docker.sock
    env_file: .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: matre
      DB_USER: matre
      DB_PASS: matre
      SELENIUM_HOST: selenium-hub
      SELENIUM_PORT: 4444
      ALLURE_URL: http://allure:5050
      ALLURE_PUBLIC_URL: http://matre.local:5050
    depends_on:
      db:
        condition: service_healthy
      php:
        condition: service_started
      selenium-hub:
        condition: service_started
      magento:
        condition: service_started
    networks:
      - matre_network

volumes:
  matre_db_data:
  matre_vendor:
  matre_magento_code:
  matre_magento_db_data:
  matre_magento_es_data:
  traefik_certs:

networks:
  matre_network:
    driver: bridge
  traefik:
    external: true
