# docker-compose.yml for MATRE (Magento Automated Test Run Environment)
#
# This configuration is intended for local development.
# Includes: Symfony app, Selenium Grid, Playwright, Allure, Magento 2
# ⚠️ Do not deploy this file to production; secrets and ports are dev-only defaults.
#
services:
  php:
    build:
      context: .
      target: app_dev
    container_name: matre_php
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker/ssh:/home/www-data/.ssh:ro
    env_file: .env
    environment:
      APP_SECRET: "matre-dev-secret"
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: matre
      DB_USER: matre
      DB_PASS: matre
      MAILER_DSN: "smtp://mailpit:1025"
      ALLURE_URL: http://allure:5050
      ALLURE_PUBLIC_URL: ${ALLURE_PUBLIC_URL:-http://matre.local:5050}
      GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /home/www-data/.ssh/id_ed25519"
    depends_on:
      - db
    networks:
      - matre_network

  nginx:
    image: nginx:1.25-alpine
    container_name: matre_nginx
    # Direct HTTP access (no Traefik needed for local dev)
    ports:
      - "8089:80"
    volumes:
      - .:/app:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php
    networks:
      - matre_network
    # Note: For production with Traefik/SSL, add back:
    #   - traefik network
    #   - traefik.* labels for routing

  db:
    image: mariadb:11
    container_name: matre_db
    ports:
      - "33067:3306"
    environment:
      MARIADB_DATABASE: matre
      MARIADB_USER: matre
      MARIADB_PASSWORD: matre
      MARIADB_ROOT_PASSWORD: matre_root
    volumes:
      - matre_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - matre_network

  mailpit:
    image: axllent/mailpit:latest
    container_name: matre_mailpit
    ports:
      - "1031:1025"  # SMTP
      - "8031:8025"  # Web UI
    networks:
      - matre_network

  frontend-build:
    image: node:20-alpine
    container_name: matre_frontend_build
    working_dir: /app
    command: sh -c "npm install && npm run build"
    volumes:
      - .:/app
    networks:
      - matre_network

  scheduler:
    build:
      context: .
      target: app_dev
    container_name: matre_scheduler
    command: php bin/console messenger:consume async scheduler_test_runner scheduler_cron scheduled_test_messages --time-limit=60 -vv
    restart: unless-stopped
    volumes:
      - .:/app
    env_file: .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: matre
      DB_USER: matre
      DB_PASS: matre
    depends_on:
      db:
        condition: service_healthy
      php:
        condition: service_started
    networks:
      - matre_network

  # ===========================================
  # Local HTTPS (optional) - disabled by default
  # ===========================================
  # First generate certs: ./docker/traefik/generate-local-certs.sh
  # Then: docker-compose --profile local-ssl up -d
  # Access: https://matre.local

  traefik-local:
    image: traefik:v3.6
    container_name: matre_traefik
    profiles:
      - local-ssl
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - ~/.docker/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/traefik.local.yml:/etc/traefik/traefik.yml:ro
      - ./docker/traefik/dynamic.local.yml:/etc/traefik/dynamic.local.yml:ro
      - ./docker/traefik/certs:/etc/traefik/certs:ro
    networks:
      - traefik
    restart: unless-stopped

  # ===========================================
  # Production SSL (Let's Encrypt)
  # ===========================================
  # Run with: docker-compose --profile production up -d

  traefik:
    image: traefik:v3.6
    container_name: matre_traefik_prod
    profiles:
      - production
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./docker/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_certs:/letsencrypt
    environment:
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-}
    networks:
      - traefik
      - matre_network  # Required to route to nginx
    restart: unless-stopped

  # ===========================================
  # Test Infrastructure Services
  # ===========================================

  # Selenium Hub - Grid coordinator
  selenium-hub:
    image: selenium/hub:latest
    container_name: matre_selenium_hub
    ports:
      - "4442:4442"
      - "4443:4443"
      - "4444:4444"
    environment:
      SE_NODE_MAX_SESSIONS: 4
      SE_SESSION_REQUEST_TIMEOUT: 300
    networks:
      - matre_network

  # Chromium Node - Browser for MFTF tests (ARM64 compatible)
  # noVNC live preview available at https://{APP_DOMAIN}:7900
  chrome-node:
    image: selenium/node-chromium:latest
    container_name: matre_chrome_node
    shm_size: 2gb
    ports:
      - "7900:7900"  # noVNC web viewer for live test preview
    depends_on:
      - selenium-hub
    environment:
      SE_EVENT_BUS_HOST: selenium-hub
      SE_EVENT_BUS_PUBLISH_PORT: 4442
      SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
      SE_NODE_MAX_SESSIONS: ${SE_NODE_MAX_SESSIONS:-2}
      SE_NODE_SESSION_TIMEOUT: 300
      SE_VNC_NO_PASSWORD: ${SE_VNC_NO_PASSWORD:-true}
      # Chromium anti-bot detection flags (hides navigator.webdriver)
      SE_BROWSER_ARGS_DISABLE_BLINK: "--disable-blink-features=AutomationControlled"
      SE_BROWSER_ARGS_DISABLE_INFOBARS: "--disable-infobars"
    networks:
      - matre_network

  # Playwright Runner - For Playwright tests
  playwright:
    build:
      context: ./docker/playwright
      dockerfile: Dockerfile
    container_name: matre_playwright
    volumes:
      - ./var/test-modules:/app/modules:ro
      - ./var/playwright-results:/app/results
    environment:
      DISPLAY: ":99"
    networks:
      - matre_network

  # Allure Report Service
  allure:
    image: frankescobar/allure-docker-service:latest
    container_name: matre_allure
    ports:
      - "5050:5050"
      - "5252:5252"
    volumes:
      - ./var/allure-results:/app/allure-results
      - ./var/allure-reports:/app/default-reports
      - ./var/allure-projects:/app/projects
    environment:
      CHECK_RESULTS_EVERY_SECONDS: 3
      KEEP_HISTORY: 25
      KEEP_HISTORY_LATEST: 10
    networks:
      - matre_network

  # Magento 2 - For MFTF binary and test execution
  magento:
    build:
      context: ./docker/magento
      dockerfile: Dockerfile
    container_name: matre_magento
    volumes:
      - matre_magento_code:/var/www/html
      # Dev mode: mount DEV_MODULE_PATH directly; Prod: mount cloned module
      - ${DEV_MODULE_PATH:-./var/test-modules/current}:/var/www/html/app/code/TestModule:ro
      - ./var/mftf-results:/var/www/html/dev/tests/acceptance/tests/_output
      - ./var/mftf-results/allure-results:/var/www/html/dev/tests/acceptance/allure-results
    env_file: .env
    environment:
      MAGENTO_RUN_MODE: developer
      MAGENTO_VERSION: ${MAGENTO_VERSION:-2.4.7}
      MAGENTO_PUBLIC_KEY: ${MAGENTO_PUBLIC_KEY:-}
      MAGENTO_PRIVATE_KEY: ${MAGENTO_PRIVATE_KEY:-}
      DB_HOST: magento-db
      DB_NAME: magento
      DB_USER: magento
      DB_PASS: magento
      OPENSEARCH_HOST: magento-opensearch
      REDIS_HOST: magento-redis
      SELENIUM_HOST: selenium-hub
      SELENIUM_PORT: 4444
    depends_on:
      - magento-db
      - magento-opensearch
      - magento-redis
      - selenium-hub
    networks:
      - matre_network

  # Magento Database
  magento-db:
    image: mariadb:10.6
    container_name: matre_magento_db
    environment:
      MYSQL_DATABASE: magento
      MYSQL_USER: magento
      MYSQL_PASSWORD: magento
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - matre_magento_db_data:/var/lib/mysql
    networks:
      - matre_network

  # Magento OpenSearch (required for Magento 2.4.8+)
  magento-opensearch:
    image: opensearchproject/opensearch:2.14.0
    container_name: matre_magento_opensearch
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Admin123!
    volumes:
      - matre_magento_opensearch_data:/usr/share/opensearch/data
    networks:
      - matre_network

  # Magento Redis
  magento-redis:
    image: redis:7-alpine
    container_name: matre_magento_redis
    networks:
      - matre_network

  # Test Worker - Consumes per-environment test_runner queue
  # Supports parallel execution: docker-compose up -d --scale test-worker=N
  # Each worker processes different environments concurrently (per-env locking)
  test-worker:
    build:
      context: .
      target: app_dev
    command: php -d memory_limit=512M bin/console messenger:consume test_runner_per_env --time-limit=3600 -vv
    restart: unless-stopped
    volumes:
      - .:/app
      - ./var/test-modules:/app/var/test-modules
      - ./var/mftf-results:/app/var/mftf-results
      - ./var/playwright-results:/app/var/playwright-results
      - ./var/allure-results:/app/var/allure-results
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker/ssh:/home/www-data/.ssh:ro
    env_file: .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: matre
      DB_USER: matre
      DB_PASS: matre
      SELENIUM_HOST: selenium-hub
      SELENIUM_PORT: 4444
      ALLURE_URL: http://allure:5050
      ALLURE_PUBLIC_URL: ${ALLURE_PUBLIC_URL:-http://matre.local:5050}
      GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i /home/www-data/.ssh/id_ed25519"
    depends_on:
      db:
        condition: service_healthy
      php:
        condition: service_started
      selenium-hub:
        condition: service_started
      magento:
        condition: service_started
    networks:
      - matre_network

volumes:
  matre_db_data:
  matre_magento_code:
  matre_magento_db_data:
  matre_magento_opensearch_data:
  traefik_certs:

networks:
  matre_network:
    driver: bridge
  traefik:
    driver: bridge
