# Production override for ABB server deployment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml --profile production up -d
#
# IMPORTANT: After starting, run:
# 1. docker exec matre_php php bin/console doctrine:migrations:migrate --no-interaction
# 2. docker exec matre_php php bin/console app:create-admin <username> <email> <password>
# 3. docker exec matre_php php bin/console cache:warmup --env=prod

services:
  # Disable local Traefik (production profile enables the prod one)
  traefik-local:
    profiles:
      - disabled

  # Enable production Traefik (remove profile requirement)
  traefik:
    profiles: []

  # Production optimizations - use image vendor, no bind mounts
  php:
    environment:
      APP_ENV: prod
      APP_DEBUG: "0"
    volumes: []  # No volume mounts - use image vendor

  test-worker:
    environment:
      APP_ENV: prod
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./var/test-modules:/app/var/test-modules
      - ./var/mftf-results:/app/var/mftf-results
      - ./var/playwright-results:/app/var/playwright-results
      - ./var/allure-results:/app/var/allure-results

  scheduler:
    environment:
      APP_ENV: prod
    volumes: []  # No volume mounts - use image vendor

  nginx:
    volumes:
      - ./public:/app/public:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  # noVNC with password + Traefik routing
  # Note: noVNC uses absolute paths (/app/*, /core/*, /vendor/*) for assets,
  # so we need additional routers to catch these requests
  chrome-node:
    environment:
      SE_VNC_NO_PASSWORD: "false"
    networks:
      - matre_network
      - traefik
    labels:
      - "traefik.enable=true"
      # Main noVNC router
      - "traefik.http.routers.novnc.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/novnc`)"
      - "traefik.http.routers.novnc.entrypoints=websecure"
      - "traefik.http.routers.novnc.tls=true"
      - "traefik.http.routers.novnc.middlewares=novnc-stripprefix"
      - "traefik.http.middlewares.novnc-stripprefix.stripprefix.prefixes=/novnc"
      - "traefik.http.services.novnc.loadbalancer.server.port=7900"
      # Router for /app/* assets (noVNC JS, images)
      - "traefik.http.routers.novnc-app.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/app`)"
      - "traefik.http.routers.novnc-app.entrypoints=websecure"
      - "traefik.http.routers.novnc-app.tls=true"
      - "traefik.http.routers.novnc-app.service=novnc"
      - "traefik.http.routers.novnc-app.priority=100"
      # Router for /core/* assets (noVNC core modules)
      - "traefik.http.routers.novnc-core.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/core`)"
      - "traefik.http.routers.novnc-core.entrypoints=websecure"
      - "traefik.http.routers.novnc-core.tls=true"
      - "traefik.http.routers.novnc-core.service=novnc"
      - "traefik.http.routers.novnc-core.priority=100"
      # Router for /vendor/* assets (noVNC vendor libs)
      - "traefik.http.routers.novnc-vendor.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/vendor`)"
      - "traefik.http.routers.novnc-vendor.entrypoints=websecure"
      - "traefik.http.routers.novnc-vendor.tls=true"
      - "traefik.http.routers.novnc-vendor.service=novnc"
      - "traefik.http.routers.novnc-vendor.priority=100"
      # Router for /websockify WebSocket connection
      - "traefik.http.routers.novnc-websockify.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/websockify`)"
      - "traefik.http.routers.novnc-websockify.entrypoints=websecure"
      - "traefik.http.routers.novnc-websockify.tls=true"
      - "traefik.http.routers.novnc-websockify.service=novnc"
      - "traefik.http.routers.novnc-websockify.middlewares=websockify-stripprefix"
      - "traefik.http.middlewares.websockify-stripprefix.stripprefix.prefixes=/websockify"
      - "traefik.http.routers.novnc-websockify.priority=100"

  # Allure reports with Traefik routing
  allure:
    networks:
      - matre_network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.allure.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/allure`)"
      - "traefik.http.routers.allure.entrypoints=websecure"
      - "traefik.http.routers.allure.tls=true"
      - "traefik.http.routers.allure.middlewares=allure-stripprefix"
      - "traefik.http.middlewares.allure-stripprefix.stripprefix.prefixes=/allure"
      - "traefik.http.services.allure.loadbalancer.server.port=5050"
