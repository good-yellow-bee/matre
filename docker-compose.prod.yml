# Production override for ABB server deployment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# IMPORTANT: After starting, run:
# 1. docker exec matre_php php bin/console doctrine:migrations:migrate --no-interaction
# 2. docker exec matre_php php bin/console app:create-admin <username> <email> <password>
# 3. docker exec matre_php php bin/console cache:warmup --env=prod

services:
  # Disable local Traefik (production profile enables the prod one)
  traefik-local:
    profiles:
      - disabled

  # Disable mailpit in production (using real SMTP)
  mailpit:
    profiles:
      - disabled

  # Disable frontend-build in production (assets are built in app image)
  frontend-build:
    profiles:
      - disabled

  # Enable production Traefik (remove profile requirement)
  traefik:
    profiles: []

  # Production optimizations - use image vendor; bind mount build output for manifest sync
  php:
    environment:
      APP_ENV: prod
      APP_DEBUG: "0"
      MAILER_DSN: ${MAILER_DSN}
      MAIL_FROM: ${MAIL_FROM:-abbmagento.mftf.tests@gmail.com}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      ALLURE_PUBLIC_URL: https://${APP_DOMAIN:-matre.local}/allure
    volumes:
      - ./public/build:/app/public/build:ro

  # Test workers - 4 replicas (2 nodes Ã— 2 sessions = 4 concurrent browser sessions)
  # Each worker handles different environment (per-env locking prevents conflicts)
  test-worker:
    deploy:
      replicas: 4
    environment:
      APP_ENV: prod
      MAILER_DSN: ${MAILER_DSN}
      MAIL_FROM: ${MAIL_FROM:-abbmagento.mftf.tests@gmail.com}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      ALLURE_PUBLIC_URL: https://${APP_DOMAIN:-matre.local}/allure
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./var/test-modules:/app/var/test-modules
      - ./var/mftf-results:/app/var/mftf-results
      - ./var/playwright-results:/app/var/playwright-results
      - ./var/allure-results:/app/var/allure-results

  scheduler:
    environment:
      APP_ENV: prod
      MAILER_DSN: ${MAILER_DSN}
      MAIL_FROM: ${MAIL_FROM:-abbmagento.mftf.tests@gmail.com}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      ALLURE_PUBLIC_URL: https://${APP_DOMAIN:-matre.local}/allure
    volumes: []  # No volume mounts - use image vendor

  nginx:
    ports: []  # Disable direct port, use Traefik
    volumes:
      - ./public:/app/public:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - matre_network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matre.rule=Host(`${APP_DOMAIN:-matre.local}`)"
      - "traefik.http.routers.matre.entrypoints=websecure"
      - "traefik.http.routers.matre.tls=true"
      - "traefik.http.routers.matre.tls.certresolver=${CERT_RESOLVER:-}"
      - "traefik.http.routers.matre.middlewares=security-headers@file"
      - "traefik.http.services.matre.loadbalancer.server.port=80"
      - "traefik.http.routers.matre-http.rule=Host(`${APP_DOMAIN:-matre.local}`)"
      - "traefik.http.routers.matre-http.entrypoints=web"
      - "traefik.http.routers.matre-http.middlewares=redirect-https"
      - "traefik.http.middlewares.redirect-https.redirectscheme.scheme=https"

  # Chrome nodes - 2 replicas for parallel test execution
  # noVNC uses absolute paths (/app/*, /core/*, /vendor/*) for assets,
  # so we need additional routers to catch these requests
  chrome-node:
    environment:
      SE_VNC_NO_PASSWORD: "false"
      SE_NODE_MAX_SESSIONS: 2
    deploy:
      replicas: 2
    networks:
      - matre_network
      - traefik
    labels:
      - "traefik.enable=true"
      # Main noVNC router
      - "traefik.http.routers.novnc.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/novnc`)"
      - "traefik.http.routers.novnc.entrypoints=websecure"
      - "traefik.http.routers.novnc.tls=true"
      - "traefik.http.routers.novnc.middlewares=novnc-stripprefix"
      - "traefik.http.middlewares.novnc-stripprefix.stripprefix.prefixes=/novnc"
      - "traefik.http.services.novnc.loadbalancer.server.port=7900"
      # Router for /app/* assets (noVNC JS, images)
      - "traefik.http.routers.novnc-app.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/app`)"
      - "traefik.http.routers.novnc-app.entrypoints=websecure"
      - "traefik.http.routers.novnc-app.tls=true"
      - "traefik.http.routers.novnc-app.service=novnc"
      - "traefik.http.routers.novnc-app.priority=100"
      # Router for /core/* assets (noVNC core modules)
      - "traefik.http.routers.novnc-core.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/core`)"
      - "traefik.http.routers.novnc-core.entrypoints=websecure"
      - "traefik.http.routers.novnc-core.tls=true"
      - "traefik.http.routers.novnc-core.service=novnc"
      - "traefik.http.routers.novnc-core.priority=100"
      # Router for /vendor/* assets (noVNC vendor libs)
      - "traefik.http.routers.novnc-vendor.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/vendor`)"
      - "traefik.http.routers.novnc-vendor.entrypoints=websecure"
      - "traefik.http.routers.novnc-vendor.tls=true"
      - "traefik.http.routers.novnc-vendor.service=novnc"
      - "traefik.http.routers.novnc-vendor.priority=100"
      # Router for /websockify WebSocket connection
      - "traefik.http.routers.novnc-websockify.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/websockify`)"
      - "traefik.http.routers.novnc-websockify.entrypoints=websecure"
      - "traefik.http.routers.novnc-websockify.tls=true"
      - "traefik.http.routers.novnc-websockify.service=novnc"
      - "traefik.http.routers.novnc-websockify.middlewares=websockify-stripprefix"
      - "traefik.http.middlewares.websockify-stripprefix.stripprefix.prefixes=/websockify"
      - "traefik.http.routers.novnc-websockify.priority=100"

  # Allure reports with Traefik routing
  allure:
    environment:
      URL_PREFIX: /allure
    networks:
      - matre_network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.allure.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/allure`)"
      - "traefik.http.routers.allure.entrypoints=websecure"
      - "traefik.http.routers.allure.tls=true"
      - "traefik.http.routers.allure.middlewares=allure-stripprefix"
      - "traefik.http.middlewares.allure-stripprefix.stripprefix.prefixes=/allure"
      - "traefik.http.services.allure.loadbalancer.server.port=5050"
