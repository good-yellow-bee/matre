{# Modern Sidebar Admin Layout - Tailwind + Bootstrap hybrid #}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Admin{% endblock %} - {{ site_settings.adminPanelTitle }}</title>

    {# Google Fonts - Inter (optimized loading) #}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    {# Bootstrap 5 CSS (for Vue components) #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    {# Tailwind CSS via Vite (built from tailwind.css) #}
    {{ vite_entry_link_tags('admin') }}

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Ensure Bootstrap components render inside Tailwind layout */
        .admin-content .table { margin-bottom: 0; }
        .admin-content .btn { font-family: 'Inter', sans-serif; }

        /* Sidebar collapse */
        .sidebar-transition { transition: width 0.2s ease, margin-left 0.2s ease, opacity 0.2s ease; }
        .sidebar-collapsed #admin-sidebar { width: 0; overflow: hidden; border-right: none; opacity: 0; }
        .sidebar-collapsed #admin-sidebar * { visibility: hidden; }
        #sidebar-toggle i { transition: transform 0.2s ease; }
        .sidebar-collapsed #sidebar-toggle i { transform: rotate(180deg); }
    </style>

    {% block stylesheets %}{% endblock %}
</head>
<body class="bg-slate-50 text-slate-900 antialiased flex h-screen overflow-hidden text-sm" id="admin-body">

    {# Sidebar #}
    <aside id="admin-sidebar" class="w-64 border-r border-slate-200 flex flex-col bg-white shrink-0 sidebar-transition">
        <div class="h-14 flex items-center px-6 border-b border-slate-200">
            <a href="{{ path('admin_dashboard') }}" class="font-bold text-lg tracking-tight text-slate-900 no-underline">
                <i class="bi bi-speedometer2 mr-2 text-blue-600"></i>
                {{ site_settings.adminPanelTitle }}
            </a>
        </div>

        <div class="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
            <div class="px-3 mb-2 text-xs font-medium text-slate-400 uppercase tracking-wider">Platform</div>

            <a href="{{ path('admin_dashboard') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_dashboard' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-house-door text-base"></i>
                Dashboard
            </a>

            <div class="px-3 mt-6 mb-2 text-xs font-medium text-slate-400 uppercase tracking-wider">Test Automation</div>

            <a href="{{ path('admin_test_run_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_test_run' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-play-circle text-base"></i>
                Test Runs
            </a>

            <a href="{{ path('admin_test_history') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_test_history' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-clock-history text-base"></i>
                Test History
            </a>

            <a href="{{ path('admin_test_environment_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_test_environment' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-server text-base"></i>
                Environments
            </a>

            <a href="{{ path('admin_test_suite_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_test_suite' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-collection text-base"></i>
                Test Suites
            </a>

            <a href="{{ path('admin_env_variable_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_env_variable' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-braces text-base"></i>
                Env Variables
            </a>

            {% if is_granted('ROLE_ADMIN') %}
            <div class="px-3 mt-6 mb-2 text-xs font-medium text-slate-400 uppercase tracking-wider">Administration</div>

            <a href="{{ path('admin_user_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_user' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-people text-base"></i>
                Users
            </a>

            <a href="{{ path('admin_notification_template_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_notification_template' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-chat-square-text text-base"></i>
                Notification Templates
            </a>
            {% endif %}

            <div class="px-3 mt-6 mb-2 text-xs font-medium text-slate-400 uppercase tracking-wider">System</div>

            <a href="{{ path('admin_settings_edit') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_settings' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-gear text-base"></i>
                Settings
            </a>

            <a href="{{ path('admin_cron_job_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_cron_job' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-clock-history text-base"></i>
                Cron Jobs
            </a>

            <a href="{{ path('admin_audit_log_index') }}"
               class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium no-underline transition-colors {{ app.request.get('_route') starts with 'admin_audit_log' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900' }}">
                <i class="bi bi-journal-text text-base"></i>
                Audit Logs
            </a>
        </div>

        {# User section at bottom #}
        <div class="p-4 border-t border-slate-200">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-700 text-sm">
                    {{ app.user.username|slice(0, 2)|upper }}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-slate-900 truncate">{{ app.user.username }}</div>
                    <div class="text-xs text-slate-500 truncate">{{ app.user.email }}</div>
                </div>
                <a href="{{ path('admin_profile_notifications') }}" class="text-slate-400 hover:text-slate-600 p-1" title="Notification Settings">
                    <i class="bi bi-bell text-lg"></i>
                </a>
                <a href="{{ path('app_logout') }}" class="text-slate-400 hover:text-slate-600 p-1" title="Logout">
                    <i class="bi bi-box-arrow-right text-lg"></i>
                </a>
            </div>
        </div>
    </aside>

    {# Main Content #}
    <main class="flex-1 flex flex-col overflow-hidden">
        {# Header #}
        <header class="h-14 flex items-center justify-between px-8 border-b border-slate-200 bg-white shrink-0">
            <div class="flex items-center gap-4 text-sm text-slate-500">
                <button id="sidebar-toggle" class="p-1.5 -ml-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors" title="Toggle sidebar">
                    <i class="bi bi-layout-sidebar text-lg"></i>
                </button>
            </div>
            <div class="flex items-center text-sm text-slate-500">
                <span>Admin</span>
                <span class="mx-2 text-slate-300">/</span>
                <span class="text-slate-900 font-medium">
                    {% if app.request.get('_route') == 'admin_dashboard' %}Dashboard
                    {% elseif app.request.get('_route') starts with 'admin_page' %}Pages
                    {% elseif app.request.get('_route') starts with 'admin_category' %}Categories
                    {% elseif app.request.get('_route') starts with 'admin_user' %}Users
                    {% elseif app.request.get('_route') starts with 'admin_settings' %}Settings
                    {% elseif app.request.get('_route') starts with 'admin_cron_job' %}Cron Jobs
                    {% elseif app.request.get('_route') starts with 'admin_env_variable' %}Env Variables
                    {% elseif app.request.get('_route') starts with 'admin_profile' %}Profile
                    {% elseif app.request.get('_route') starts with 'admin_notification_template' %}Notification Templates
                    {% elseif app.request.get('_route') starts with 'admin_audit_log' %}Audit Logs
                    {% else %}Overview{% endif %}
                </span>
            </div>
        </header>

        {# Scrollable Page Content #}
        <div class="flex-1 overflow-auto p-8 admin-content">
            {# Flash Messages #}
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show mb-4" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endfor %}

            {% block body %}{% endblock %}
        </div>
    </main>

    {# Bootstrap JS (for alerts, modals, etc) #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    {# TinyMCE Rich Text Editor #}
    {% block tinymce %}
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="{{ asset('tinymce-init.js') }}" type="module"></script>
    {% endblock %}

    {# Admin JavaScript #}
    {{ vite_entry_script_tags('admin') }}

    {# Global Toast Handler - checks sessionStorage for pending toasts #}
    <script>
    (function() {
        const TOAST_KEY = 'matre_pending_toast';
        const pending = sessionStorage.getItem(TOAST_KEY);
        if (pending) {
            sessionStorage.removeItem(TOAST_KEY);
            try {
                const { message, type } = JSON.parse(pending);
                const icons = {
                    success: 'bi-check-circle-fill',
                    error: 'bi-exclamation-circle-fill',
                    warning: 'bi-exclamation-triangle-fill',
                    info: 'bi-info-circle-fill'
                };
                const toast = document.createElement('div');
                toast.className = 'toast-notification toast-' + type;
                const icon = document.createElement('i');
                icon.className = 'bi ' + (icons[type] || icons.info);
                const span = document.createElement('span');
                span.textContent = message;
                toast.appendChild(icon);
                toast.appendChild(span);
                document.body.appendChild(toast);
                setTimeout(function() { toast.classList.add('toast-fade-out'); }, type === 'error' ? 5000 : 3000);
                setTimeout(function() { toast.remove(); }, type === 'error' ? 5300 : 3300);
            } catch (e) { console.error('Toast parse error:', e); }
        }
    })();
    </script>

    {# Sidebar Toggle #}
    <script>
    (function() {
        const SIDEBAR_KEY = 'matre_sidebar_collapsed';
        const body = document.getElementById('admin-body');
        const toggle = document.getElementById('sidebar-toggle');

        if (!body || !toggle) return;

        if (localStorage.getItem(SIDEBAR_KEY) === 'true') {
            body.classList.add('sidebar-collapsed');
        }

        toggle.addEventListener('click', function() {
            body.classList.toggle('sidebar-collapsed');
            localStorage.setItem(SIDEBAR_KEY, body.classList.contains('sidebar-collapsed'));
        });
    })();
    </script>

    {% block javascripts %}{% endblock %}
</body>
</html>
