{% extends 'admin/base.html.twig' %}

{% block title %}Test Run #{{ run.id }}{% endblock %}

{% block body %}
<div class="dashboard-welcome mb-4">
    <h1>Test Run #{{ run.id }}</h1>
    <p class="subtitle">
        {{ run.environment.name }} • {{ run.type|upper }} •
        {{ run.triggeredBy|title }} trigger
    </p>
</div>

<div class="row">
    <div class="col-md-8">
        {# Status Card #}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Run Status</h5>
                {% set statusColors = {
                    'pending': 'secondary',
                    'preparing': 'info',
                    'cloning': 'info',
                    'running': 'warning',
                    'reporting': 'info',
                    'completed': 'success',
                    'failed': 'danger',
                    'cancelled': 'secondary'
                } %}
                <span class="badge bg-{{ statusColors[run.status]|default('secondary') }} fs-6">
                    {{ run.status|upper }}
                </span>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th style="width: 150px">Environment</th>
                        <td>
                            <a href="{{ path('admin_test_environment_show', {id: run.environment.id}) }}">
                                {{ run.environment.name }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td><span class="badge bg-{{ run.type == 'mftf' ? 'primary' : 'info' }}">{{ run.type|upper }}</span></td>
                    </tr>
                    {% if run.suite %}
                    <tr>
                        <th>Suite</th>
                        <td>
                            <a href="{{ path('admin_test_suite_show', {id: run.suite.id}) }}">
                                {{ run.suite.name }}
                            </a>
                        </td>
                    </tr>
                    {% endif %}
                    {% if run.testFilter %}
                    <tr>
                        <th>Filter</th>
                        <td><code>{{ run.testFilter }}</code></td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Triggered By</th>
                        <td>{{ run.triggeredBy|title }}</td>
                    </tr>
                    <tr>
                        <th>Created</th>
                        <td>{{ run.createdAt|date('Y-m-d H:i:s') }}</td>
                    </tr>
                    {% if run.startedAt %}
                    <tr>
                        <th>Started</th>
                        <td>{{ run.startedAt|date('Y-m-d H:i:s') }}</td>
                    </tr>
                    {% endif %}
                    {% if run.completedAt %}
                    <tr>
                        <th>Completed</th>
                        <td>{{ run.completedAt|date('Y-m-d H:i:s') }}</td>
                    </tr>
                    <tr>
                        <th>Duration</th>
                        <td>{{ run.durationFormatted }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        {# Results Summary #}
        {% set counts = run.resultCounts %}
        {% if counts.total > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Results Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <div class="h2 text-success mb-0">{{ counts.passed }}</div>
                        <small class="text-muted">Passed</small>
                    </div>
                    <div class="col">
                        <div class="h2 text-danger mb-0">{{ counts.failed }}</div>
                        <small class="text-muted">Failed</small>
                    </div>
                    <div class="col">
                        <div class="h2 text-warning mb-0">{{ counts.broken }}</div>
                        <small class="text-muted">Broken</small>
                    </div>
                    <div class="col">
                        <div class="h2 text-secondary mb-0">{{ counts.skipped }}</div>
                        <small class="text-muted">Skipped</small>
                    </div>
                </div>

                {% if counts.total > 0 %}
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: {{ (counts.passed / counts.total * 100)|round }}%"></div>
                    <div class="progress-bar bg-danger" style="width: {{ (counts.failed / counts.total * 100)|round }}%"></div>
                    <div class="progress-bar bg-warning" style="width: {{ (counts.broken / counts.total * 100)|round }}%"></div>
                    <div class="progress-bar bg-secondary" style="width: {{ (counts.skipped / counts.total * 100)|round }}%"></div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Test Results Table #}
        {% if run.results|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Test Results</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Screenshot</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in run.results %}
                        <tr>
                            <td>
                                {{ result.testName }}
                                {% if result.testId %}
                                    <br>
                                    <small class="text-muted">
                                        {{ result.testId }}
                                        <a href="{{ path('admin_test_history', {testId: result.testId, environmentId: run.environment.id}) }}"
                                           class="ms-2 text-decoration-none"
                                           title="View history for this test">
                                            <i class="bi bi-clock-history"></i>
                                        </a>
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                {% set resultColors = {
                                    'passed': 'success',
                                    'failed': 'danger',
                                    'broken': 'warning',
                                    'skipped': 'secondary'
                                } %}
                                <span class="badge bg-{{ resultColors[result.status]|default('secondary') }}">
                                    {{ result.status|upper }}
                                </span>
                            </td>
                            <td>{{ result.duration ? (result.duration ~ 's') : '-' }}</td>
                            <td>
                                {% if result.screenshotPath %}
                                <a href="{{ path('admin_test_run_artifact', {id: run.id, filename: result.screenshotPath}) }}"
                                   data-screenshot
                                   class="btn btn-sm btn-outline-primary"
                                   title="View Screenshot">
                                    <i class="bi bi-image"></i>
                                </a>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if result.errorMessage %}
                        <tr>
                            <td colspan="4" class="bg-light">
                                <pre class="text-danger mb-0 small">{{ result.errorMessage|slice(0, 500) }}{% if result.errorMessage|length > 500 %}...{% endif %}</pre>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {# Artifacts Section #}
        {% if artifacts.screenshots|length > 0 or artifacts.html|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Artifacts</h5>
            </div>
            <div class="card-body">
                {# Screenshots Gallery #}
                {% if artifacts.screenshots|length > 0 %}
                <h6 class="mb-3">Screenshots ({{ artifacts.screenshots|length }})</h6>
                <div class="row g-2 mb-4">
                    {% for screenshot in artifacts.screenshots %}
                    <div class="col-6 col-md-4 col-lg-3">
                        <a href="{{ path('admin_test_run_artifact', {id: run.id, filename: screenshot}) }}"
                           data-screenshot
                           class="d-block border rounded overflow-hidden"
                           title="{{ screenshot }}">
                            <img src="{{ path('admin_test_run_artifact', {id: run.id, filename: screenshot}) }}"
                                 class="img-fluid"
                                 alt="{{ screenshot }}"
                                 style="max-height: 150px; width: 100%; object-fit: cover;">
                        </a>
                        <small class="d-block text-truncate text-muted mt-1" title="{{ screenshot }}">
                            {{ screenshot }}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {# HTML Reports #}
                {% if artifacts.html|length > 0 %}
                <h6 class="mb-3">HTML Reports ({{ artifacts.html|length }})</h6>
                <div class="list-group">
                    {% for html in artifacts.html %}
                    <a href="{{ path('admin_test_run_artifact', {id: run.id, filename: html}) }}"
                       target="_blank" rel="noopener"
                       class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="bi bi-file-earmark-code me-2 text-primary"></i>
                        {{ html }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Output Log - Live streaming for running tests #}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Output Log</h5>
                {% if run.status in ['preparing', 'cloning', 'running'] %}
                <span class="badge bg-warning" id="live-badge">
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    Live
                </span>
                {% endif %}
            </div>
            <div class="card-body">
                <pre id="output-log" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap;">{{ run.output|default('Waiting for output...') }}</pre>
            </div>
        </div>

        {# Error Message #}
        {% if run.errorMessage %}
        <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Error</h5>
            </div>
            <div class="card-body">
                <pre class="text-danger mb-0">{{ run.errorMessage }}</pre>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        {# Actions #}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Actions</h5>
            </div>
            <div class="card-body d-grid gap-2">
                {% if run.canBeCancelled %}
                <form action="{{ path('admin_test_run_cancel', {id: run.id}) }}" method="post">
                    <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ run.id) }}">
                    <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Cancel this test run?')">
                        <i class="bi bi-x-circle"></i> Cancel Run
                    </button>
                </form>
                {% endif %}

                {% if run.status in ['completed', 'failed', 'cancelled'] %}
                <form action="{{ path('admin_test_run_retry', {id: run.id}) }}" method="post">
                    <input type="hidden" name="_token" value="{{ csrf_token('retry' ~ run.id) }}">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-arrow-repeat"></i> Retry
                    </button>
                </form>
                {% endif %}

                <a href="{{ path('admin_test_run_index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>

        {# Reports #}
        {% if run.reports|length > 0 %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Reports</h5>
            </div>
            <div class="card-body d-grid gap-2">
                {% for report in run.reports %}
                <a href="{{ report.publicUrl }}" target="_blank" rel="noopener" class="btn btn-primary">
                    <i class="bi bi-file-earmark-bar-graph"></i>
                    {{ report.reportType|title }} Report
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if run.status in ['pending', 'preparing', 'cloning', 'running', 'reporting'] %}
    <script>
        const outputEl = document.getElementById('output-log');
        const liveBadge = document.getElementById('live-badge');
        const apiUrl = '{{ path('admin_test_run_live_output', {id: run.id}) }}';
        let lastStatus = '{{ run.status }}';

        async function fetchLiveOutput() {
            try {
                const resp = await fetch(apiUrl);
                const data = await resp.json();

                if (data.output) {
                    outputEl.textContent = data.output;
                    outputEl.scrollTop = outputEl.scrollHeight; // Auto-scroll to bottom
                }

                // Update live badge visibility
                if (liveBadge) {
                    const isRunning = ['preparing', 'cloning', 'running'].includes(data.status);
                    liveBadge.style.display = isRunning ? '' : 'none';
                }

                // Reload page when status changes (so badge updates)
                if (data.status !== lastStatus) {
                    location.reload();
                }
            } catch (e) {
                console.error('Failed to fetch live output:', e);
            }
        }

        // Poll every 2 seconds
        setInterval(fetchLiveOutput, 2000);
        fetchLiveOutput(); // Initial fetch
    </script>
    {% endif %}

    {# Screenshot lightbox modal #}
    {% if artifacts.screenshots|length > 0 %}
    <script>
        document.querySelectorAll('[data-screenshot]').forEach(el => {
            el.addEventListener('click', e => {
                e.preventDefault();
                const src = el.href;
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out;padding:20px';
                const img = document.createElement('img');
                img.src = src;
                img.style.cssText = 'max-width:100%;max-height:100%;object-fit:contain';
                modal.appendChild(img);
                modal.onclick = () => modal.remove();
                document.body.appendChild(modal);
            });
        });
    </script>
    {% endif %}
{% endblock %}
